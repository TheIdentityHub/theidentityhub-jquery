(function(e){function g(a){var b=new e.Deferred,c=window.open(a.url,"Authenticate","status=0,resizable=0,scrollbars=1,location=0,toolbar=0,menubar=0,titlebar=0,left= "+(window.screenX+(window.outerWidth-a.width)/2)+",top="+(window.screenY+(window.outerHeight-a.height)/2)+",height="+a.height+",width="+a.width),k=setInterval(function(){try{if(0<=c.location.href.indexOf(a.redirectUri)){var d={href:c.location.href,hash:c.location.hash,search:c.location.search};setTimeout(function(){b.resolve(d)},1E3);c.close();c=null;clearInterval(k)}}catch(n){}},1E3);return b.promise()}function f(){var a,d=(new Date).getTime();if((a=b.principal&&void 0!==b.principal&&b.principal.token&&void 0!==b.principal.token?b.principal.token:JSON.parse(sessionStorage.getItem("access_token")))&&a.access_token&&a.expiry>d)return a;b.principal.token=null;b.principal.isAuthenticated=!1;sessionStorage.removeItem("access_token");b.oauthParameters.manualSignIn||b.signIn()}function l(a){a&&a.access_token&&""!==a.access_token&&(b.principal.token={access_token:a.access_token,expiry:(new Date).getTime()+1E3*a.expires_in,scope:a.scope},b.principal.isAuthenticated=!0,b.principal.isVerified="1"===a.resource_owner_identity_verified,sessionStorage.setItem("access_token",JSON.stringify(b.principal.token)));return null}function h(a){var d=new e.Deferred;a&&""!==a||(a=window.location.hash);a&&""!==a?(a=m(a),l(a),b.principal.isAuthenticated&&(e.when(b.getProfile(),b.getRoles()).then(function(){d.resolve()}),a=a.state,window.location.hash=a&&""!==a?a:"")):(b.oauthParameters.manualSignIn||b.signIn(),d.resolve());return d.promise()}function m(a){if("?"===a[0]||"#"===a[0])a=a.substr(1,a.length-1);"/"===a[0]&&(a=a.substr(1,a.length-1));a=a.split("&");var b=[];if(a&&0<a.length)for(var c=0;c<a.length;c++){var e=a[c].split("=");2===e.length&&(b[e[0]]=decodeURIComponent(e[1]))}return b}var b={oauthParameters:{clientId:"",baseUrl:"",redirectUri:"",scopes:"",manualSignIn:!0,popup:!1},principal:{isAuthenticated:!1,isVerified:!1,token:null,identity:null,roles:[],isInRole:function(a){if(!b.principal.isAuthenticated||0===b.principal.roles.length)return!1;var d=!1;e.each(b.principal.roles,function(b,e){d=e.name===a;return!d});return d}},config:function(a){b.oauthParameters=e.extend(b.oauthParameters,a);a=b.oauthParameters.baseUrl;if("string"!==typeof a)throw{error:"The baseUrl is required."};a=a.trim();"/"===a[a.length-1]&&(a=a.substring(0,a.length-1));b.oauthParameters.baseUrl=a;return h().then(function(){b.principal.isAuthenticated||b.oauthParameters.manualSignIn||b.signIn()})},signIn:function(a){var d=new e.Deferred,c=b.oauthParameters.baseUrl+"/oauth2/v1/auth?response_type=token&client_id="+encodeURIComponent(b.oauthParameters.clientId)+"&redirect_uri="+encodeURIComponent(b.oauthParameters.redirectUri);void 0!==b.oauthParameters.scopes&&(c+="&scope="+encodeURIComponent(b.oauthParameters.scopes));c=a&&""!==a?c+("&state="+encodeURIComponent(a)):c+("&state="+encodeURIComponent(window.location.hash));b.oauthParameters.popup?g({url:c,redirectUri:b.oauthParameters.redirectUri,width:600,height:500}).then(function(a){h(a.hash).then(function(){d.resolve()})}):window.location.href=c;return d.promise()},signOut:function(){var a=new e.Deferred,d=f();sessionStorage.removeItem("access_token");b.principal.isAuthenticated=!1;b.principal.isVerified=!1;b.principal.identity=null;e.ajax({type:"POST",url:b.oauthParameters.baseUrl+"/oauth2/v1/revoke",data:e.param({token:d.access_token,token_type_hint:"access_token",client_id:b.oauthParameters.clientId}),beforeSend:function(a){a.setRequestHeader("Authorization","Bearer "+d.access_token)}}).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)});return a.promise()},getProfile:function(){var a=new e.Deferred,d=f();e.ajax(b.oauthParameters.baseUrl+"/api/identity/v1/",{type:"GET",beforeSend:function(a){a.setRequestHeader("Authorization","Bearer "+d.access_token)}}).success(function(c){b.principal.identity=c;a.resolve(c)}).error(function(b){a.reject(b)});return a.promise()},getFriends:function(){var a=new e.Deferred,d=f();e.ajax(b.oauthParameters.baseUrl+"/api/identity/v1/friends",{type:"GET",beforeSend:function(a){a.setRequestHeader("Authorization","Bearer "+d.access_token)}}).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)});return a.promise()},getAccounts:function(){var a=new e.Deferred,d=f();e.ajax(b.oauthParameters.baseUrl+"/api/identity/v1/accounts",{type:"GET",beforeSend:function(a){a.setRequestHeader("Authorization","Bearer "+d.access_token)}}).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)});return a.promise()},getRoles:function(){var a=new e.Deferred,d=f();e.ajax(b.oauthParameters.baseUrl+"/api/identity/v1/roles",{type:"GET",beforeSend:function(a){a.setRequestHeader("Authorization","Bearer "+d.access_token)}}).success(function(c){b.principal.roles=c;a.resolve(c)}).error(function(b){a.reject(b)});return a.promise},requireTwoFactorAuthentication:function(){var a=new e.Deferred,d=f();if(b.principal.isVerified)return a.resolve(!0),a.promise();e.ajax(b.oauthParameters.baseUrl+"/oauth2/v1/verify",{type:"GET",beforeSend:function(a){a.setRequestHeader("Authorization","Bearer "+d.access_token)}}).success(function(c){c&&c.resource_owner_identity_verified?(b.principal.isVerified=!0,a.resolve(!0)):(c=b.oauthParameters.baseUrl+"/Authenticate/PerformTwoFactorAuthenticationVerification?accessToken="+d.access_token+"&clientId="+_this.oauthParameters.clientId+"&returnUrl="+encodeURIComponent(_this.oauthParameters.redirectUri),g({url:c,redirectUri:b.oauthParameters.redirectUri,width:600,height:500}).then(function(c){var d=c.href.indexOf("resource_owner_identity_verified=");-1!=d&&c.href.length>=d+34?(c="1"==c.href[d+33],b.principal.isVerified=c,a.resolve(c)):a.resolve(!1)}))}).error(function(b){a.reject(b)});return a.promise()},addAccount:function(a){var d=new e.Deferred,c=f();g({url:a.signInUrl+"?access_token="+c.access_token+"&returnurl="+encodeURIComponent(b.oauthParameters.redirectUri),redirectUri:b.oauthParameters.redirectUri,width:600,height:500}).then(function(a){d.resolve()});return d.promise()}};e.identityService=b})(jQuery);